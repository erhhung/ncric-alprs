# ALPRS Infrastructure

## Local Environment

Add to "`~/.bash_profile`":

```bash
export TF_CLI_ARGS_init="-compact-warnings -upgrade"
export TF_CLI_ARGS_plan="-compact-warnings"
export TF_CLI_ARGS_apply="-compact-warnings"
```

## AWS Environment

### AWS Systems Manager

* **Quick Setup**
  * Enable all **Host Management** configuration options

## Terraform State

Create S3 bucket for Terraform to store its state:  
_(adjust values for **prod** environment accordingly)_

```bash
aws s3api create-bucket \
  --profile alprscom \
  --bucket alprs-tfstate-dev \
  --create-bucket-configuration "LocationConstraint=us-west-2" \
  --object-ownership BucketOwnerEnforced

aws s3api put-public-access-block \
  --profile alprscom \
  --bucket alprs-tfstate-dev \
  --public-access-block-configuration "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"
```

**_Assumes AWS CLI profiles `alprscom` and `alprsgov` already exist!_**

## Terraform Init

```bash
terraform init -backend-config config/dev.conf -upgrade
```

## Terraform Apply

_Due to some `for_each` values that depend on resource attributes that cannot be determined
  until apply, the `-target` option must be used to create those dependent resources first._

```bash
# download dev.tfvars from S3 bucket if you don't have one
aws s3 cp s3://alprs-tfstate-dev/tfstate/dev.tfvars config/

# explicit -target is only necessary if provisioning the tfstate for the first time
terraform apply -var-file config/dev.tfvars -target aws_ses_domain_dkim.astrometrics

terraform apply -var-file config/dev.tfvars
```

## EC2 Instances

Seven EC2 instances are provisioned by Terraform:

* **PostgreSQL** — Primary "alprs" (a.k.a. "Black Panther") database; staging (a.k.a. "Atlas") database for NCRIC org; Rundeck datastore
* **Elasticsearch** — Exposes ports for both HTTP and transport; Kibana on HTTPS
* **Conductor** — Catalogs ingested ALPR reads in database; triggers indexing
* **Datastore** — REST API server; manages storage of ingested ALPR images
* **Indexer** — Sends ingested ALPR reads to Elasticsearch for indexing
* **Bastion Host** — Builds & deploys the webapp; hosts the "`lattice-org`" app on port 9000; hosts the Rundeck server on port 4440
* **Rundeck Worker** — Worker node where all Rundeck ingestion jobs get executed

### Bootstrapping

Each instance-specific .tf file builds its own "`bootstrap.sh`" script with supporting files (dot files, scripts, packages) to be installed.

"`bootstrap.sh`" is composed of "`shared/prolog.sh`", followed by "`boot.tfpl`" and "`boot.sh`" files, followed by one or more "`install.tfpl`" and "`install.sh`" files (for each section), and ending with "`shared/epilog.sh`".  
"`bootstrap.sh`" could be composed of several sections, each generated by another .tf file (e.g. the bastion host installs both the webapp and Rundeck server).

These files are all "`aws_s3_object`" resources uploaded into the "`alprs-tfstate-dev`" bucket under "`userdata/`".

Since "`bootstrap.sh`" is often too big to be directly included as instance "userdata", each instance attaches "`shared/s3boot.sh`" instead.  
That script then downloads the appropriate "`bootstrap.sh`" from S3 as "`/bootstrap.sh`" and executes it.

Log output from "`/bootstrap.sh`" is written to "`/bootstrap.log`".

Note that it can take over 10 minutes to fully bootstrap an instance, but if all succeeds, the final output in "`/bootstrap.log`" should be "`===== END BOOTSTRAP =====`".

## S3 Buckets

Seven S3 buckets are used by the stack, six directly provisioned by Terraform:

* **alprs-tfstate-dev** — Terraform state file and bootstrapping files for all instances _(manually created)_
* **alprs-config-dev** — YAML configuration files (with passwords) for Conductor/Datastore/Indexer/Shuttle
* **alprs-webapp-dev** — AstroMetrics frontend served via CloudFront
* **alprs-sftp-dev** — Incoming data from ALPR feeds via SFTP
* **alprs-media-dev** — Storage for ingested ALPR images
* **alprs-audit-dev** — Audit logs generated by Conductor/Datastore/Indexer; AWS logs for CloudFront/ELB/SFTP
* **alprs-backup-dev** — Copies of built service/webapp tarballs; PostgreSQL backups
