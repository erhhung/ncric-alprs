- defaultTab: nodes
  description: |-
    Hourly job for SCSO into Aurora with entity sets broken out by agency
    * End datetime range is the bottom of the hour that the job is run. For a job at 9:10 am, covers 8-9 am.
    * All SCSO data is in UTC time
  executionEnabled: true
  id: 6875860d-b358-4f7f-8c52-377fd0ca0914
  loglevel: INFO
  multipleExecutions: true
  name: 'Recurring SCSO: realtime - hourly'
  nodeFilterEditable: false
  nodefilters:
    dispatch:
      excludePrecedence: true
      keepgoing: false
      rankOrder: ascending
      successOnEmptyNodeFilter: false
      threadcount: '1'
    filter: 'name: Worker'
  nodesSelectedByDefault: true
  notification:
    onfailure:
      email:
        attachLog: true
        attachLogInFile: true
        recipients: alprs.devops@maiveric.com
        subject: '[Rundeck:PROD] Job ${execution.status}: ${job.name}'
  notifyAvgDurationThreshold: null
  options:
  - description: AWS region
    hidden: true
    name: region
    secure: true
    storagePath: keys/region
    valueExposed: true
  - description: SFTP bucket
    hidden: true
    name: s3_bucket
    secure: true
    storagePath: keys/s3_bucket
    valueExposed: true
  - description: Bucket prefix
    hidden: true
    name: s3_prefix
    secure: true
    storagePath: keys/s3_prefix/scso
    valueExposed: true
  - description: API endpoint
    hidden: true
    name: api_url
    secure: true
    storagePath: keys/api_url
    valueExposed: true
  - description: Shuttle CLI args
    hidden: true
    name: shuttle_args
    secure: true
    storagePath: keys/shuttle_args
    valueExposed: true
  - description: PostgreSQL host
    hidden: true
    name: db_host
    secure: true
    storagePath: keys/db_host
    valueExposed: true
  - description: NCRIC database
    hidden: true
    name: db_name
    secure: true
    storagePath: keys/db_name
    valueExposed: true
  - description: PostgreSQL user
    hidden: true
    name: db_user
    secure: true
    storagePath: keys/db_user
    valueExposed: true
  - description: PostgreSQL password
    hidden: true
    name: db_pass
    secure: true
    storagePath: keys/db_pass
    valueExposed: true
  - description: Auth0 client ID
    hidden: true
    name: client_id
    secure: true
    storagePath: keys/client_id
    valueExposed: true
  - description: Auth0 user email
    hidden: true
    name: ol_user
    secure: true
    storagePath: keys/ol_user
    valueExposed: true
  - description: Auth0 user password
    hidden: true
    name: ol_pass
    secure: true
    storagePath: keys/ol_pass
    valueExposed: true
  - name: fetch_size
    value: '5000'
  plugins:
    ExecutionLifecycle: null
  schedule:
    month: '*'
    time:
      hour: '*'
      minute: '10'
      seconds: '0'
    weekday:
      day: '*'
    year: '*'
  scheduleEnabled: false
  sequence:
    commands:
    - description: hourly
      script: |-
        #!/usr/bin/env python3

        # JOB: Recurring SCSO: realtime - hourly

        from datetime import datetime, timedelta
        from pyntegrationsncric.pyntegrations.ca_ncric.scso.integration_definitions \
          import SCSOIntegration, SCSOImagesIntegration, SCSOAgenciesIntegration, \
          SCSOImageSourcesIntegration, SCSOAgenciesStandardizedIntegration
        import os

        agencies = [
          "Campbell PD",
          "Los Altos PD",
          "Manual Entries",
          "Morgan Hill PD",
          "Palo Alto PD",
          "Santa Clara County Sheriff''s Office",
          "Santa Clara Sheriff",
          "Santa Clara PD",
          "Sunnyvale DPS",
          "Sunnyvale PD"
        ]

        s3_bucket = "@option.s3_bucket@"
        s3_prefix = "@option.s3_prefix@"

        # End datetime is the beginning of the hour that the job starts in
        dt_end = datetime.now().replace(microsecond=0, second=0, minute=0)
        dt_start = dt_end - timedelta(hours=1)

        # This is now changed to "start hour" since the hour should not change here
        dt_end_str = f"{dt_end.year}-{dt_end.month}-{dt_end.day} {dt_end.hour}:00:00"
        dt_start_str = f"{dt_start.year}-{dt_start.month}-{dt_start.day} {dt_start.hour}:00:00"

        print(f"Searching {dt_start_str} through {dt_end_str} to integrate!")
        main_integration = SCSOIntegration(
            date_start=dt_start_str,
            date_end=dt_end_str,
            limit=1,
            s3_bucket=s3_bucket,
            s3_prefix=s3_prefix)

        main_table_name, images_table_name = main_integration.get_raw_data_from_s3()
        print(main_table_name, images_table_name)
        print("Got the raw data!")

        api_url = "@option.api_url@"
        fsize = @option.fetch_size@

        images_integration = SCSOImagesIntegration(
            sql=f"select * from {images_table_name}",
            base_url=api_url)

        images_clean_table_name = images_integration.clean_and_upload()
        print("Got the images data!")

        pyntegrations_path = os.environ.get("PYNTEGRATIONS_PATH")
        pyntegrations_path += "/ca_ncric"
        shuttle_path = os.environ.get("SHUTTLE_PATH")
        shuttle_args = "@option.shuttle_args@"

        try:
            for agency in agencies:
                agency_no_space = agency.replace(" ", "").replace("'", "")

                print(f"Integrating MAIN table for {agency}!")
                # integrate all with new tables
                main_integration.integrate_table(
                    sql=f"select * from {main_table_name} where standardized_agency_name = '{agency}'",
                    flight_path=pyntegrations_path+f"/ncric_flights/ncric_{agency_no_space}_flight.yaml",
                    memory_size=3,
                    shuttle_path=shuttle_path,
                    shuttle_args=shuttle_args+f" --upload-size {fsize}")
                print("Passed: integrate_table MAIN table")

                print(f"Integrating IMAGES table for {agency}!")
                # integrate images table
                images_integration.integrate_table(
                    sql=f"select * from {images_clean_table_name} where standardized_agency_name = '{agency}'",
                    flight_path=pyntegrations_path+f"/ncric_image_flights/ncric_{agency_no_space}_images_flight.yaml",
                    memory_size=5,
                    shuttle_path=shuttle_path,
                    shuttle_args=shuttle_args+f" --s3 PRODUCTION --upload-size {fsize}")
                print("Passed: integrate_table IMAGES table")

            print("Integrating AGENCIES table!")
            # integrate agencies associate only
            integration = SCSOAgenciesIntegration(
                sql=f'select distinct "agency_id", "agencyName", "datasource", "agencyAcronym" from {main_table_name}',
                base_url=api_url)
            table_name = integration.clean_and_upload()
            integration.integrate_table(
                clean_table_name=table_name,
                shuttle_path=shuttle_path,
                shuttle_args=shuttle_args)

            print("Integrating IMAGE SOURCES table!")
            # integrate image sources associate only
            integration = SCSOImageSourcesIntegration(
                sql=f'select distinct "camera_id", "LPRCameraName", "datasource" from {main_table_name}',
                base_url=api_url)
            table_name = integration.clean_and_upload()
            integration.integrate_table(
                clean_table_name=table_name,
                shuttle_path=shuttle_path,
                shuttle_args=shuttle_args)

            print("Integrating STANDARDIZED AGENCIES table!")
            sagency_integration = SCSOAgenciesStandardizedIntegration(
                sql="""select distinct standardized_agency_name from standardized_agency_names
                    where \"ol.datasource\" = 'SCSO'
                    """,
                base_url=api_url)
            sagency_integration.integrate_table(
                sql="""select distinct standardized_agency_name from standardized_agency_names
                    where \"ol.datasource\" = 'SCSO'
                    """,
                shuttle_path=shuttle_path,
                shuttle_args=shuttle_args)

        except Exception as e:
            raise RuntimeError(f"Something went wrong with the job! Error message: {str(e)}")
    keepgoing: false
    strategy: node-first
  timeZone: America/Los_Angeles
  uuid: 6875860d-b358-4f7f-8c52-377fd0ca0914
