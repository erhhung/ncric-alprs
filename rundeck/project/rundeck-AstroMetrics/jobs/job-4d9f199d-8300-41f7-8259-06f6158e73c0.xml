<joblist>
  <job>
    <context>
      <options preserveOrder='true'>
        <option name='region' secure='true' storagePath='keys/region' valueExposed='true'>
          <description>AWS region</description>
          <hidden>true</hidden>
        </option>
        <option name='s3_bucket' secure='true' storagePath='keys/s3_bucket' valueExposed='true'>
          <description>SFTP bucket</description>
          <hidden>true</hidden>
        </option>
        <option name='s3_prefix' secure='true' storagePath='keys/s3_prefix/scso' valueExposed='true'>
          <description>Bucket prefix</description>
          <hidden>true</hidden>
        </option>
        <option name='api_url' secure='true' storagePath='keys/api_url' valueExposed='true'>
          <description>API endpoint</description>
          <hidden>true</hidden>
        </option>
        <option name='shuttle_args' secure='true' storagePath='keys/shuttle_args' valueExposed='true'>
          <description>Shuttle CLI args</description>
          <hidden>true</hidden>
        </option>
      </options>
    </context>
    <defaultTab>nodes</defaultTab>
    <description><![CDATA[Catchup job for SCSO into Aurora with entity sets broken out by agency
* End datetime range is the bottom of the hour that the job is run. For a job at 9:10 am, covers 8-9 am.
* Does the whole day for the day before yesterday
* All SCSO data is in UTC time]]></description>
    <dispatch>
      <excludePrecedence>true</excludePrecedence>
      <keepgoing>false</keepgoing>
      <rankOrder>ascending</rankOrder>
      <successOnEmptyNodeFilter>false</successOnEmptyNodeFilter>
      <threadcount>1</threadcount>
    </dispatch>
    <executionEnabled>true</executionEnabled>
    <id>4d9f199d-8300-41f7-8259-06f6158e73c0</id>
    <loglevel>INFO</loglevel>
    <multipleExecutions>true</multipleExecutions>
    <name>Recurring SCSO: asynchronous - goes back two days</name>
    <nodeFilterEditable>false</nodeFilterEditable>
    <nodefilters>
      <filter>name: Worker</filter>
    </nodefilters>
    <nodesSelectedByDefault>true</nodesSelectedByDefault>
    <plugins />
    <schedule>
      <month month='*' />
      <time hour='00' minute='23' seconds='0' />
      <weekday day='*' />
      <year year='*' />
    </schedule>
    <scheduleEnabled>false</scheduleEnabled>
    <sequence keepgoing='false' strategy='node-first'>
      <command>
        <description>2 days ago</description>
        <script><![CDATA[#!/usr/bin/env python3

from datetime import datetime, timedelta
from pyntegrations.ca_ncric.scso.integration_definitions import \
  SCSOIntegration, SCSOImagesIntegration, SCSOAgenciesIntegration, \
  SCSOImageSourcesIntegration, SCSOAgenciesStandardizedIntegration
import os

agencies = [
  "Campbell PD",
  "Los Altos PD",
  "Manual Entries",
  "Morgan Hill PD",
  "Palo Alto PD",
  "Santa Clara County Sheriff''s Office",
  "Santa Clara Sheriff",
  "Santa Clara PD",
  "Sunnyvale DPS",
  "Sunnyvale PD"
]

s3_bucket = "@option.s3_bucket@"
s3_prefix = "@option.s3_prefix@"

# Include start date and end date - IN UTC
dt_end = datetime.now().replace(microsecond=0, second=0, minute=0, hour=0)
dt_start = dt_end - timedelta(days=2)
dt_end = dt_end - timedelta(days=1)
print("dt_start:", dt_start)
print("dt_end:", dt_end)

dt_end_str = f"{dt_end.year}-{dt_end.month}-{dt_end.day} 00:00:00"
dt_start_str = f"{dt_start.year}-{dt_start.month}-{dt_start.day} 00:00:00"

print(f"Searching {dt_start_str} through {dt_end_str} to integrate!")
main_integration = SCSOIntegration(
    date_start=dt_start_str,
    date_end=dt_end_str,
    limit=1,
    s3_bucket=s3_bucket,
    s3_prefix=s3_prefix)

main_table_name, images_table_name = main_integration.get_raw_data_from_s3()
print(main_table_name, images_table_name)
print("Got the raw data!")

api_url = "@option.api_url@"
images_integration = SCSOImagesIntegration(
    sql=f"select * from {images_table_name}",
    base_url=api_url)

images_clean_table_name = images_integration.clean_and_upload()
print("Got the images data!")

pyntegrations_path = os.environ.get("PYNTEGRATIONS_PATH")
pyntegrations_path += "/ca_ncric"
shuttle_path = os.environ.get("SHUTTLE_PATH")
shuttle_args = "@option.shuttle_args@ @option.region@"

try:
    for agency in agencies:
        agency_no_space = agency.replace(" ", "").replace("'", "")

        print(f"Integrating MAIN table for {agency}!")
        # integrate all with new tables
        main_integration.integrate_table(
            sql=f"select * from {main_table_name} where standardized_agency_name = '{agency}'",
            flight_path=pyntegrations_path+f"/ncric_flights/ncric_{agency_no_space}_flight.yaml",
            memory_size=3,
            shuttle_path=shuttle_path,
            shuttle_args=shuttle_args)
        print("Passed: integrate_table MAIN table")

        print(f"Integrating IMAGES table for {agency}!")
        # integrate images table
        images_integration.integrate_table(
            sql=f"select * from {images_clean_table_name} where standardized_agency_name = '{agency}'",
            flight_path=pyntegrations_path+f"/ncric_image_flights/ncric_{agency_no_space}_images_flight.yaml",
            memory_size=5,
            shuttle_path=shuttle_path,
            shuttle_args=shuttle_args+" --s3 PRODUCTION")
        print("Passed: integrate_table IMAGES table")

    print("Integrating AGENCIES table!")
    # integrate agencies associate only
    integration = SCSOAgenciesIntegration(
        sql=f'select distinct "agency_id", "agencyName", "datasource", "agencyAcronym" from {main_table_name}',
        base_url=api_url)
    table_name = integration.clean_and_upload()
    integration.integrate_table(
        clean_table_name=table_name,
        shuttle_path=shuttle_path,
        shuttle_args=shuttle_args)

    print("Integrating IMAGE SOURCES table!")
    # integrate image sources associate only
    integration = SCSOImageSourcesIntegration(
        sql=f'select distinct "camera_id", "LPRCameraName", "datasource" from {main_table_name}',
        base_url=api_url)
    table_name = integration.clean_and_upload()
    integration.integrate_table(
        clean_table_name=table_name,
        shuttle_path=shuttle_path,
        shuttle_args=shuttle_args)

    print("Integrating STANDARDIZED AGENCIES table!")
    sagency_integration = SCSOAgenciesStandardizedIntegration(
        sql="""select distinct standardized_agency_name from standardized_agency_names
            where \"ol.datasource\" = 'SCSO'
            """,
        base_url=api_url)
    sagency_integration.integrate_table(
        sql="""select distinct standardized_agency_name from standardized_agency_names
            where \"ol.datasource\" = 'SCSO'
            """,
        shuttle_path=shuttle_path,
        shuttle_args=shuttle_args)

except Exception as e:
    raise RuntimeError(f"Something went wrong with the job! Error message: {str(e)}")]]></script>
        <scriptargs />
      </command>
    </sequence>
    <timeZone>America/Los_Angeles</timeZone>
    <uuid>4d9f199d-8300-41f7-8259-06f6158e73c0</uuid>
  </job>
</joblist>