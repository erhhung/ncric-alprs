<joblist>
  <job>
    <context>
      <options preserveOrder='true'>
        <option name='ol_client_id' secure='true' storagePath='keys/project/NCRIC/ncric_at_openlattice/ol_client_id' valueExposed='true'>
          <hidden>true</hidden>
        </option>
        <option name='ol_password' secure='true' storagePath='keys/project/NCRIC/ncric_at_openlattice/ol_password' valueExposed='true'>
          <hidden>true</hidden>
        </option>
        <option name='ol_user' secure='true' storagePath='keys/project/NCRIC/ncric_at_openlattice/ol_user' valueExposed='true'>
          <hidden>true</hidden>
        </option>
      </options>
    </context>
    <defaultTab>nodes</defaultTab>
    <description><![CDATA[Catchup job for SCSO into Aurora and entity sets broken out by agency
- end datetime range is the bottom of the hour that the job is run. For a job at 9:10 am, covers 8-9 am.
- all SCSO data is in UTC time]]></description>
    <executionEnabled>false</executionEnabled>
    <id>4d9f199d-8300-41f7-8259-06f6158e73c0</id>
    <loglevel>INFO</loglevel>
    <multipleExecutions>true</multipleExecutions>
    <name>Recurring asynchronous: SCSO - goes back two days</name>
    <nodeFilterEditable>false</nodeFilterEditable>
    <plugins />
    <schedule>
      <month month='*' />
      <time hour='00' minute='23' seconds='0' />
      <weekday day='*' />
      <year year='*' />
    </schedule>
    <scheduleEnabled>true</scheduleEnabled>
    <sequence keepgoing='false' strategy='node-first'>
      <command>
        <description>2 days ago</description>
        <script><![CDATA[#!/opt/anaconda/envs/openlattice/bin/python

import pyntegrationsncric
from datetime import datetime, timedelta

agencies = [
  "Campbell PD",
	"Los Altos PD",
	"Manual Entries",
	"Morgan Hill PD",
	"Palo Alto PD",
	"Santa Clara Sheriff",
	"Santa Clara PD",
	"Sunnyvale DPS",
	"Sunnyvale PD"
]

dt_end = datetime.now().replace(microsecond=0, second=0, minute=0, hour=0) - timedelta(days = 1)
dt_start = datetime.now().replace(microsecond=0, second=0, minute=0, hour=0) - timedelta(days = 2)

dt_end_str = f"{dt_end.year}-{dt_end.month}-{dt_end.day} {dt_end.hour}:{dt_end.minute}:00"
dt_start_str = f"{dt_start.year}-{dt_start.month}-{dt_start.day} {dt_start.hour}:{dt_start.minute}:00"

print("Integrating MAIN SCSO table!")
print(f"Searching through {dt_start_str} and {dt_end_str}")

main_integration = pyntegrations.ca_ncric.scso.integration_definitions.SCSOIntegration(date_start=dt_start_str,
                                                                                        date_end=dt_end_str,
                                                                                        limit = 1,
                                                                                        s3_bucket="sftp.openlattice.com",
                                                                                        s3_prefix="ncricscso")
main_table_name, images_table_name = main_integration.get_raw_data_from_s3()

# NOTE you must insert your base_url in all of the integration definitions - "https://api.openlattice.com" will no longer exist
images_integration = pyntegrations.ca_ncric.scso.integration_definitions.SCSOImagesIntegration(sql=f"select * from {images_table_name}",
                                                                                                base_url="https://api.openlattice.com")
images_clean_table_name = images_integration.clean_and_upload()

print(main_table_name, images_table_name)
try:
    for agency in agencies:
        print(f"Integrating MAIN table for {agency}!")
        agency_no_space = agency.replace(" ", "")
    # integrate all with new tables
        main_integration.integrate_table(
            shuttle_path="opt/openlattice/shuttle/shuttle-0.0.4-SNAPSHOT/bin/shuttle",
            shuttle_args=' --read-rate-limit 0 --shuttle-config openlattice-alpha-config us-gov-west-1 --data-store alpr',
            flight_path=f"ca_ncric/ncric_flights/ncric_{agency_no_space}_flight.yaml",
            sql=f"select * from {main_table_name} where standardized_agency_name = '{agency}'"
            )

        print(f"Integrating IMAGES table for {agency}!")
        # integrate images table
        images_integration.integrate_table(
            sql = f"select * from {images_clean_table_name} where standardized_agency_name = '{agency}'",
            flight_path=f"ca_ncric/ncric_image_flights/ncric_{agency_no_space}_images_flight.yaml",
            memory_size=5,
            shuttle_path="opt/openlattice/shuttle/shuttle-0.0.4-SNAPSHOT/bin/shuttle",
            shuttle_args=' --s3 PRODUCTION --shuttle-config openlattice-alpha-config us-gov-west-1 --data-store alpr'
            )

    print("Integrating AGENCIES table!")
    # integrate agencies associate only
    integration = pyntegrations.ca_ncric.scso.integration_definitions.SCSOAgenciesIntegration(sql=f'select distinct "agency_id", "agencyName", "datasource", "agencyAcronym" from {main_table_name}',
                                                                                            base_url="https://api.openlattice.com")
    table_name = integration.clean_and_upload()
    integration.integrate_table(
        clean_table_name = table_name,
        shuttle_path="opt/openlattice/shuttle/shuttle-0.0.4-SNAPSHOT/bin/shuttle",
        shuttle_args=' --read-rate-limit 0 --shuttle-config openlattice-alpha-config us-gov-west-1 --data-store alpr'
        )

    print("Integrating IMAGE SOURCES table!")
    # integrate image sources associate only
    integration = pyntegrations.ca_ncric.scso.integration_definitions.SCSOImageSourcesIntegration(sql=f'select distinct "camera_id", "LPRCameraName", "datasource" from {main_table_name}',
                                                                                                base_url="https://api.openlattice.com")
    table_name = integration.clean_and_upload()
    integration.integrate_table(
        clean_table_name = table_name,
        shuttle_path="opt/openlattice/shuttle/shuttle-0.0.4-SNAPSHOT/bin/shuttle",
        shuttle_args=' --read-rate-limit 0 --shuttle-config openlattice-alpha-config us-gov-west-1 --data-store alpr'
        )

    print("Integrating STANDARDIZED AGENCIES integration!")
    sagency_integration=pyntegrations.ca_ncric.scso.integration_definitions.SCSOAgenciesStandardizedIntegration(
        sql="""select distinct standardized_agency_name from standardized_agency_names
        where \"ol.datasource\" = 'SCSO';""",
        base_url="https://api.openlattice.com")
    sagency_integration.integrate_table(
        sql="""select distinct standardized_agency_name from standardized_agency_names
        where \"ol.datasource\" = 'SCSO';""",
        shuttle_path="opt/openlattice/shuttle/shuttle-0.0.4-SNAPSHOT/bin/shuttle",
        shuttle_args=' --read-rate-limit 0 --shuttle-config openlattice-alpha-config us-gov-west-1 --data-store alpr'
        )

except Exception as e:
    raise RuntimeError(f"Something went wrong with the job! Error message: {str(e)}. Dropping tables.")
    ]]></script>
        <scriptargs />
      </command>
    </sequence>
    <timeZone>America/Los_Angeles</timeZone>
    <uuid>4d9f199d-8300-41f7-8259-06f6158e73c0</uuid>
  </job>
</joblist>