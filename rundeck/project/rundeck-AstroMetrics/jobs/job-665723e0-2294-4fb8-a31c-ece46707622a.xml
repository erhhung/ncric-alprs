<joblist>
  <job>
    <context>
      <options preserveOrder='true'>
        <option name='region' secure='true' storagePath='keys/region' valueExposed='true'>
          <description>AWS region</description>
          <hidden>true</hidden>
        </option>
        <option name='s3_bucket' secure='true' storagePath='keys/s3_bucket' valueExposed='true'>
          <description>SFTP bucket</description>
          <hidden>true</hidden>
        </option>
        <option name='s3_prefix' secure='true' storagePath='keys/s3_prefix/boss4' valueExposed='true'>
          <description>Bucket prefix</description>
          <hidden>true</hidden>
        </option>
        <option name='api_url' secure='true' storagePath='keys/api_url' valueExposed='true'>
          <description>API endpoint</description>
          <hidden>true</hidden>
        </option>
        <option name='shuttle_args' secure='true' storagePath='keys/shuttle_args' valueExposed='true'>
          <description>Shuttle CLI args</description>
          <hidden>true</hidden>
        </option>
        <option name='db_host' secure='true' storagePath='keys/db_host' valueExposed='true'>
          <description>PostgreSQL host</description>
          <hidden>true</hidden>
        </option>
        <option name='db_name' secure='true' storagePath='keys/db_name' valueExposed='true'>
          <description>NCRIC database</description>
          <hidden>true</hidden>
        </option>
        <option name='db_user' secure='true' storagePath='keys/db_user' valueExposed='true'>
          <description>PostgreSQL user</description>
          <hidden>true</hidden>
        </option>
        <option name='db_pass' secure='true' storagePath='keys/db_pass' valueExposed='true'>
          <description>PostgreSQL password</description>
          <hidden>true</hidden>
        </option>
        <option name='client_id' secure='true' storagePath='keys/client_id' valueExposed='true'>
          <description>Auth0 client ID</description>
          <hidden>true</hidden>
        </option>
        <option name='ol_user' secure='true' storagePath='keys/ol_user' valueExposed='true'>
          <description>Auth0 user email</description>
          <hidden>true</hidden>
        </option>
        <option name='ol_pass' secure='true' storagePath='keys/ol_pass' valueExposed='true'>
          <description>Auth0 user password</description>
          <hidden>true</hidden>
        </option>
        <option name='upload_size' value='5000' />
      </options>
    </context>
    <defaultTab>nodes</defaultTab>
    <description><![CDATA[Hourly job for Santa Clara Sheriff only, from BOSS4 into Postgres and the agency entity sets
* This ONLY WORKS if in the SQL statement we use a single curly quote in the "standardized_agency_name" column and DO NOT comment it out
* End datetime range is the bottom of the hour that the job is run. For a job at 9:15 am, covers 8-9 am.
* All BOSS4 data is in UTC time]]></description>
    <dispatch>
      <excludePrecedence>true</excludePrecedence>
      <keepgoing>false</keepgoing>
      <rankOrder>ascending</rankOrder>
      <successOnEmptyNodeFilter>false</successOnEmptyNodeFilter>
      <threadcount>1</threadcount>
    </dispatch>
    <executionEnabled>true</executionEnabled>
    <id>665723e0-2294-4fb8-a31c-ece46707622a</id>
    <loglevel>INFO</loglevel>
    <multipleExecutions>true</multipleExecutions>
    <name>Recurring BOSS4 - Santa Clara Sheriff: realtime - hourly</name>
    <nodeFilterEditable>false</nodeFilterEditable>
    <nodefilters>
      <filter>name: Worker</filter>
    </nodefilters>
    <nodesSelectedByDefault>true</nodesSelectedByDefault>
    <notification>
      <onfailure>
        <email attachLog='true' attachLogInFile='true' recipients='alprs.devops@maiveric.com' subject='[Rundeck:PROD] Job ${execution.status}: ${job.name}' />
      </onfailure>
    </notification>
    <notifyAvgDurationThreshold />
    <plugins />
    <retry delay='5m'>2</retry>
    <schedule>
      <month month='*' />
      <time hour='*' minute='15' seconds='0' />
      <weekday day='*' />
      <year year='*' />
    </schedule>
    <scheduleEnabled>true</scheduleEnabled>
    <sequence keepgoing='false' strategy='node-first'>
      <command>
        <description>hourly</description>
        <script><![CDATA[#!/usr/bin/env python3

# JOB: Recurring BOSS4 - Santa Clara Sheriff: realtime - hourly

from datetime import datetime, timedelta
from sqlalchemy import create_engine
from pyntegrationsncric.pyntegrations.ca_ncric.boss4.integration_definitions \
    import BOSS4Integration, BOSS4ImagesIntegration, BOSS4AgenciesIntegration, \
    BOSS4ImageSourcesIntegration, BOSS4StandardizedAgenciesIntegration
import pyntegrationsncric.pyntegrations.ca_ncric.utils.openlattice_functions as of
import os

agency = "Santa Clara County SO"
agency_no_space = agency.replace(" ", "")

s3_bucket = "@option.s3_bucket@"
s3_prefix = "@option.s3_prefix@"

# End datetime is the beginning of the hour that the job starts in
dt_end = datetime.now().replace(microsecond=0, second=0, minute=0)
dt_start = dt_end - timedelta(hours=1)

# This is now changed to "start hour" since the hour should not change here
dt_end_str = f"{dt_end.year}-{dt_end.month}-{dt_end.day} {dt_end.hour}:00:00"
dt_start_str = f"{dt_start.year}-{dt_start.month}-{dt_start.day} {dt_start.hour}:00:00"
print(f"Searching {dt_start_str} through {dt_end_str} to integrate!")

client_id = "@option.client_id@"
ol_user = "@option.ol_user@"
ol_pass = "@option.ol_pass@"
jwt = of.get_jwt(client_id=client_id, username=ol_user, password=ol_pass)

api_url = "@option.api_url@"
usize = @option.upload_size@

pyntegrations_path = os.environ.get("PYNTEGRATIONS_PATH")
pyntegrations_path += "/ca_ncric"
shuttle_path = os.environ.get("SHUTTLE_PATH")
shuttle_args = "@option.shuttle_args@"

main_integration = BOSS4Integration(
    jwt=jwt,
    date_start=dt_start_str,
    date_end=dt_end_str,
    raw_table_name="boss4_hr_scsheriff",
    raw_table_name_images="boss4_hr_images_scsheriff",
    s3_bucket=s3_bucket,
    s3_prefix=s3_prefix)

main_table_name, images_table_name = main_integration.get_raw_data_from_s3()
print(main_table_name, images_table_name)
print("Got the raw data!")

jwt = of.refresh_jwt_if_needed(jwt=jwt, min_ttl_mins=120,
    client_id=client_id, username=ol_user, password=ol_pass)
images_integration = BOSS4ImagesIntegration(
    jwt=jwt,
    sql=f"SELECT * FROM {images_table_name}",
    clean_table_name_root="boss4_hr_images_scsheriff",
    base_url=api_url)

images_clean_table_name = images_integration.clean_and_upload()
print("Got the images data!")

try:
    print(f"\nIntegrating MAIN table for {agency}!")
    # integrate all with new tables
    main_integration.integrate_table(
        sql=f"SELECT * FROM {main_table_name} WHERE standardized_agency_name = '{agency}'",
        flight_path=pyntegrations_path+f"/ncric_flights/ncric_{agency_no_space}_flight.yaml",
        memory_size=3,
        shuttle_path=shuttle_path,
        shuttle_args=shuttle_args+f" --upload-size {usize}")
    print("Passed: integrate_table MAIN table")

    print(f"\nIntegrating IMAGES table for {agency}!")
    # integrate images table
    images_integration.integrate_table(
        sql=f"SELECT * FROM {images_clean_table_name} WHERE standardized_agency_name = '{agency}'",
        flight_path=pyntegrations_path+f"/ncric_image_flights/ncric_{agency_no_space}_images_flight.yaml",
        memory_size=5,
        shuttle_path=shuttle_path,
        shuttle_args=shuttle_args+f" --s3 PRODUCTION --upload-size {usize}")
    print("Passed: integrate_table IMAGES table")

    print("\nIntegrating AGENCIES table!")
    # integrate agencies associate only
    integration = BOSS4AgenciesIntegration(
        jwt=jwt,
        sql=f'SELECT DISTINCT "agency_id", "agencyName", "datasource", "agencyAcronym" FROM {main_table_name}',
        clean_table_name_root="boss4_agencies",
        base_url=api_url)
    agencies_table_name = integration.clean_and_upload()
    integration.integrate_table(
        clean_table_name=agencies_table_name,
        shuttle_path=shuttle_path,
        shuttle_args=shuttle_args)

    print("\nIntegrating IMAGE SOURCES table!")
    # integrate image sources associate only
    integration = BOSS4ImageSourcesIntegration(
        jwt=jwt,
        sql=f'SELECT DISTINCT "camera_id", "LPRCameraName", "datasource" FROM {main_table_name}',
        clean_table_name_root="boss4_imagesources",
        base_url=api_url)
    image_sources_table = integration.clean_and_upload()
    integration.integrate_table(
        clean_table_name=image_sources_table,
        shuttle_path=shuttle_path,
        shuttle_args=shuttle_args)

    print("\nIntegrating STANDARDIZED AGENCIES table!")
    sagency_integration = BOSS4StandardizedAgenciesIntegration(
        jwt=jwt,
        sql='''
            SELECT DISTINCT standardized_agency_name
            FROM standardized_agency_names
            WHERE "ol.datasource" = 'BOSS4'
        ''',
        base_url=api_url)
    sagency_integration.integrate_table(
        sql='''
            SELECT DISTINCT standardized_agency_name
            FROM standardized_agency_names
            WHERE "ol.datasource" = 'BOSS4'
        ''',
        drop_table_on_success=False,
        shuttle_path=shuttle_path,
        shuttle_args=shuttle_args)

except Exception as e:
    main_integration.drop_main_table()
    main_integration.drop_images_table()
    raise RuntimeError(f"Something went wrong with the job! Dropping tables. Error message: {str(e)}")

main_integration.drop_main_table()
main_integration.drop_images_table()

db_host = "@option.db_host@"
db_name = "@option.db_name@"
db_user = "@option.db_user@"
db_pass = "@option.db_pass@"
engine = create_engine(f"postgresql://{db_user}:{db_pass}@{db_host}:5432/{db_name}")

# Drop other tables after integration is complete
of.drop_table(engine, agencies_table_name)
of.drop_table(engine, image_sources_table)]]></script>
        <scriptargs />
      </command>
    </sequence>
    <timeZone>America/Los_Angeles</timeZone>
    <uuid>665723e0-2294-4fb8-a31c-ece46707622a</uuid>
  </job>
</joblist>