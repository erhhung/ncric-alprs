<joblist>
  <job>
    <context>
      <options preserveOrder='true'>
        <option name='fetch_size' value='10'>
          <description>API read chunk size in minutes</description>
        </option>
        <option name='batch_size' value='1000'>
          <description>Batch size for writes to Atlas</description>
        </option>
        <option name='camera_chunk_size' value='100'>
          <description>Process only chunk size cameras</description>
        </option>
        <option name='camera_chunk_pointer' value='1'>
          <description>Process chunk size of cameras (helps to identify which chunk needs to be processed)</description>
        </option>
        <option name='camera_list'>
          <description>List of cameras to process and pull data</description>
        </option>
      </options>
    </context>
    <defaultTab>nodes</defaultTab>
    <description><![CDATA[Pull data from Flock Safety API server daily at midnight for the entire previous day in chunks
* Raw data is written by Flapper into the "flock_reads_{dow}" tables in the Atlas database]]></description>
    <dispatch>
      <excludePrecedence>true</excludePrecedence>
      <keepgoing>false</keepgoing>
      <rankOrder>ascending</rankOrder>
      <successOnEmptyNodeFilter>false</successOnEmptyNodeFilter>
      <threadcount>1</threadcount>
    </dispatch>
    <executionEnabled>true</executionEnabled>
    <id>d0e62b61-7691-49e9-a237-9fa01c74ccc1</id>
    <loglevel>INFO</loglevel>
    <multipleExecutions>true</multipleExecutions>
    <name>Flock: Pull RAW data daily by API - chunks</name>
    <nodeFilterEditable>false</nodeFilterEditable>
    <nodefilters>
      <filter>name: Worker</filter>
    </nodefilters>
    <nodesSelectedByDefault>true</nodesSelectedByDefault>
    <notification>
      <onfailure>
        <email attachLog='true' attachLogInFile='true' recipients='alprs.devops@maiveric.com' subject='[Rundeck:PROD] Job ${execution.status}: ${job.name}' />
      </onfailure>
    </notification>
    <notifyAvgDurationThreshold />
    <plugins />
    <scheduleEnabled>false</scheduleEnabled>
    <sequence keepgoing='false' strategy='node-first'>
      <command>
        <description>entire previous day</description>
        <script><![CDATA[#!/usr/bin/env bash

# JOB: Recurring Flock: Pull RAW data daily by API

# start at midnight PST of previous day
start=$(date -d "-1 day" "+%FT00:00:00%:z")

# FLAPPER variables are defined in /etc/environment
$FLAPPER_PATH --file $FLAPPER_CONF \
              --interval   @option.fetch_size@ \
              --batch-size @option.batch_size@ \
              --start $start \
              --hours 24 \
              --camera-chunk-size    @option.camera_chunk_size@ \
              --camera-chunk-pointer @option.camera_chunk_pointer@ \
              --camera-list          @option.camera_list@]]></script>
        <scriptargs />
      </command>
    </sequence>
    <timeout>23h</timeout>
    <uuid>d0e62b61-7691-49e9-a237-9fa01c74ccc1</uuid>
  </job>
</joblist>